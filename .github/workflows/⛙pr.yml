
name: ‚õôpr


on:
  workflow_dispatch:
  workflow_call:
    inputs:
      settings_token:
        required: false
        type: string
        default: '.'

jobs:
    create_pull_request:
      name: 'Create GitHub PR'
      runs-on: ubuntu-latest
      concurrency: release
      permissions:
        id-token: write
        contents: write
        pull-requests: write
      steps:
        - name: Install 1Password CLI
          uses: 1password/install-cli-action@v1

        - name: Load credentials
          uses: 1password/load-secrets-action@v1
          id: op-load-secrets
          with:
            export-env: false
          env:
            OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
            TOKEN: "op://git/GITHUB/TOKEN"

        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
            ref: dev
            token: ${{ steps.op-load-secrets.outputs.TOKEN }}

        - name: Check Diff
          id: diff
          env:
            GH_TOKEN: ${{ steps.op-load-secrets.outputs.TOKEN }}
          run: |
            if git diff origin/dev origin/main >/dev/null; then
              echo "CHANGE=TRUE" >> $GITHUB_OUTPUT
            else
              echo "CHANGE=FALSE" >> $GITHUB_OUTPUT
            fi

        - name: Create pull request
          if: ${{ steps.diff.outputs.CHANGE }} == "TRUE"
          id: cpr
          env:
            GH_TOKEN: ${{ steps.op-load-secrets.outputs.TOKEN }}
          run: |
            echo "${{ steps.diff.outputs.CHANGE }}"

            git config user.email "action@github.com"
            git config user.name "GitHub Action"

            pip install --upgrade pip

            pip install poetry
            poetry install --with dev

            poetry run semantic-release -vv version --print

            poetry lock
            poetry export --without-hashes --format=requirements.txt > requirements.txt
            cp requirements.txt .requirements/requirements.txt

            git add .

            git commit -m "‚¨ÜÔ∏è Update Requirements and Version"
            
            git push

            gh pr create --title "‚¨ÜÔ∏è ü§ñ - Auto Release - ${{ github.event.head_commit.message }}" \
                         --base "main" \
                         --head "dev" \
                         --body "Auto Release"

            gh pr merge --merge --auto ${{ github.event.number }}

    # push:
         # git pull origin main --rebase
    #   name: 'Push to main'
    #   needs: [create_pull_request]
    #   runs-on: ubuntu-latest
    #   concurrency: release
    #   permissions:
    #     id-token: write
    #     contents: write
    #     pull-requests: write
    #   steps:
    #     - name: Install 1Password CLI
    #       uses: 1password/install-cli-action@v1

    #     - name: Load credentials
    #       uses: 1password/load-secrets-action@v1
    #       id: op-load-secrets
    #       with:
    #         export-env: false
    #       env:
    #         OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
    #         TOKEN: "op://git/GITHUB/TOKEN"

    #     - uses: actions/checkout@v4
    #       with:
    #         fetch-depth: 0
    #         token: ${{ steps.op-load-secrets.outputs.TOKEN }}
    #     - name: Push to main
    #       env:
    #         GH_TOKEN: ${{ steps.op-load-secrets.outputs.TOKEN }}
    #       run: |
    #         git config user.email "action@github.com"
    #         git config user.name "GitHub Action"

    #         git fetch --all           
    #         git checkout origin/dev
    #         git push origin HEAD:main