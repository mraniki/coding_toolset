
name: ⛙pr


on:
  workflow_dispatch:
  workflow_call:
    inputs:
      settings_token:
        required: false
        type: string
        default: '.'

jobs:
    create_pull_request:
      name: 'Create GitHub PR'
      runs-on: ubuntu-latest
      permissions:
        pull-requests: write
      steps:
        - name: Install 1Password CLI
          uses: 1password/install-cli-action@v1

        - name: Load credentials
          uses: 1password/load-secrets-action@v1
          id: op-load-secrets
          with:
            export-env: false
          env:
            OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
            TOKEN: "op://git/GITHUB/TOKEN"

        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
            token: ${{ steps.op-load-secrets.outputs.TOKEN }}

        - name: Check Diff
          id: diff
          env:
            GH_TOKEN: ${{ steps.op-load-secrets.outputs.TOKEN }}
          run: |
            if git diff dev origin/main >/dev/null; then
              echo "no change"
            else
              echo "change"
            fi

        - name: Create pull request
          if: ${{ steps.diff.outputs.stdout }} != ''
          id: cpr
          env:
            GH_TOKEN: ${{ steps.op-load-secrets.outputs.TOKEN }}
          run: |

            git config user.email "action@github.com"
            git config user.name "GitHub Action"

            git checkout -b dev
            git add .
            git commit -am "⬆️ 🤖 (dependency)"
            git push --set-upstream origin dev

            gh pr create --title "⬆️ 🤖 - ${{ github.ref_name}}-${{ github.sha }}" \
                        --body "[${{ github.sha }}](https://github.com/${{ github.repository }}/commits/${{ github.sha }})" \
                        --head "dev" \
                        --base "main"

          
        